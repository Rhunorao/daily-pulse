<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Pulse</title>
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Billionaire+Script&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --bg: #0b0f14;
      --panel: #0f1621;
      --panel2:#0b1220;
      --border:#1f2a37;
      --text:#e8eef6;
      --muted:#9fb0c9;
      --muted2:#b7c3d6;
      --shadow: 0 18px 70px rgba(0,0,0,.32);
      --accent1:#2b6cb0;
      --accent2:#7c3aed;
      --good:#22c55e;
      --danger:#ef4444;
      --chip:#0b1220;
    }

    html[data-theme="light"]{
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#f1f5ff;
      --border:#dbe5f2;
      --text:#0b1220;
      --muted:#516279;
      --muted2:#3b4a5f;
      --shadow: 0 18px 70px rgba(17,24,39,.10);
      --chip:#ffffff;
    }

    *{ box-sizing:border-box; }
    *::before,*::after{ box-sizing:border-box; }

    body{ margin:0; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; font-size:16px; }

    header{
      padding:12px 14px; border-bottom:1px solid var(--border);
      position: sticky; top:0; background: color-mix(in srgb, var(--bg) 92%, transparent); backdrop-filter: blur(8px);
      z-index: 10;
    }

    .headerBar{
      display:grid;
      grid-template-columns: 44px 1fr 44px;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      text-align:center;
    }
    .brandMark{
      width:40px;
      height:40px;
      display:grid;
      place-items:center;
      border-radius:16px;
      border:1px solid color-mix(in srgb, var(--accent1) 35%, var(--border));
      background:
        radial-gradient(220px 160px at 20% 10%, color-mix(in srgb, var(--accent2) 40%, transparent), transparent 70%),
        radial-gradient(200px 140px at 90% 0%, color-mix(in srgb, var(--accent1) 40%, transparent), transparent 70%),
        var(--panel2);
      flex:0 0 40px;
      font-weight:1000;
      letter-spacing:.04em;
      font-size:14px;
    }
    .brandText{ display:flex; flex-direction:column; align-items:center; line-height:1.1; }
    /* Removed .brandDate */
    /* Timetable (iOS-like timeline) */
    .timetableList{
      margin-top:14px;
      display:grid;
      gap:12px;
    }

    .ttEmpty{
      padding:14px;
      border-radius:16px;
      border:1px dashed color-mix(in srgb, var(--accent1) 28%, var(--border));
      background: color-mix(in srgb, var(--panel2) 70%, transparent);
    }

    .ttRow{
      display:grid;
      grid-template-columns: 76px 18px 1fr;
      gap:10px;
      align-items:stretch;
      width:100%;
    }

    .ttTimeCol{
      padding-top:6px;
      text-align:right;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .ttRail{
      position:relative;
      display:flex;
      justify-content:center;
    }

    .ttDot{
      width:12px;
      height:12px;
      border-radius:999px;
      margin-top:10px;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      border: 1px solid color-mix(in srgb, var(--border) 65%, transparent);
    }

    .ttRail::before{
      content:"";
      position:absolute;
      top:0;
      bottom:0;
      width:2px;
      background: color-mix(in srgb, var(--border) 70%, transparent);
      border-radius:999px;
    }

    .ttCard{
      width:100%;
      max-width:100%;
      min-width:0;
      padding:14px;
      border-radius:18px;
      border:1px solid color-mix(in srgb, var(--accent1) 18%, var(--border));
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel2) 75%, transparent), var(--panel2));
    }

    .ttTitle{
      font-weight:950;
      font-size:17px;
      line-height:1.15;
    }

    .ttMeta{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    .ttCardTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }

    .ttEdit{
      border-radius:14px;
      padding:9px 10px;
      font-weight:900;
      background: color-mix(in srgb, var(--panel) 75%, transparent);
    }

    #sectionTimetable .card h2{ font-size:20px; }
    /* Script logo (Billion Miracles‚Äìstyle) */
    .brandText h1{
      font-family: 'Billionaire Script', cursive;
      font-size: 30px;
      letter-spacing: .02em;
      margin:0;
    }

    /* Removed .dateText */

    .headerActions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      flex-wrap:nowrap;
    }
    .headerLeft{ display:flex; align-items:center; justify-content:flex-start; }
    .tabs{
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      display:flex;
      gap:6px;
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      border:1px solid var(--border);
      border-radius:18px;
      padding:8px;
      z-index: 30;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      max-width: 720px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    /* Removed .dateWrap and nested rules */

    .iconBtn{
      width:44px;
      height:44px;
      padding:0;
      border-radius:14px;
      display:grid;
      place-items:center;
      font-size:16px;
    }

    @media (max-width: 520px){
      header{ padding:10px 12px; }
      .headerBar{ gap:8px; }
      .headerActions{ gap:6px; }
      .iconBtn{ width:42px; height:42px; border-radius:16px; }
      .brandMark{ width:38px; height:38px; border-radius:16px; }
    }

    .wrap{ max-width: 1100px; margin:0 auto; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ font-size:12px; border:1px solid color-mix(in srgb, var(--accent1) 30%, var(--border)); padding:6px 10px; border-radius:999px; background:var(--chip); }

    /* Segmented control (Weekdays / Weekends) */
    .seg{
      display:flex;
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      border:1px solid var(--border);
      border-radius:14px;
      padding:4px;
      gap:4px;
    }
    .segBtn{
      appearance:none;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
    }
    .segBtn.active{
      background:var(--panel2);
      border-color:color-mix(in srgb, var(--accent1) 28%, var(--border));
      color:var(--text);
    }

    input, select, button, textarea{
      background:var(--panel2); color:var(--text); border:1px solid color-mix(in srgb, var(--border) 75%, var(--accent1));
      border-radius:12px; padding:10px 12px; outline:none;
    }
    /* Consistent field sizing across iOS (time/date/text) */
    input, select, textarea{
      border-radius:14px;
      height:44px;
      padding:10px 12px;
      line-height:22px;
      font-size:16px;
    }
    textarea{ height:auto; min-height:44px; }
    input[type="time"], input[type="date"]{ height:44px; }
    input[type="date"]{ padding:9px 10px; }
    button{ cursor:pointer; border:1px solid color-mix(in srgb, var(--border) 75%, var(--accent1)); }
    button:hover{ filter: brightness(1.08); }
    .danger{ border-color: color-mix(in srgb, var(--danger) 55%, var(--border)); }
    .smallbtn{ padding:8px 10px; font-size:12px; border-radius:12px; }
    /* Slot day chips (S M T W T F S) */
    .allWeekRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin:0;
      font-size:14px;
      color:var(--text);
    }

    .dayChips{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:8px;
      width:100%;
    }

    .chip{
      display:block;
      margin:0;
      user-select:none;
    }

    .chip input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }

    .chip span{
      display:grid;
      place-items:center;
      height:40px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--accent1) 30%, var(--border));
      background: color-mix(in srgb, var(--panel2) 86%, transparent);
      font-weight:950;
      letter-spacing:.02em;
      color:var(--muted2);
    }

    .chip input:checked + span{
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent2) 22%, transparent), color-mix(in srgb, var(--accent1) 12%, transparent)), var(--panel2);
      border-color: color-mix(in srgb, var(--accent1) 55%, var(--border));
      color: var(--text);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    /* Removed duplicate .tabs that hid tabs on all devices */
    .tab{
      flex:1;
      padding:12px 8px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-width: 0;
    }
    .tab .ico{ font-size:18px; line-height:1; }
    .tab .lbl{ display:none; }
    .tab.active{
      background:var(--panel2);
      border-color:color-mix(in srgb, var(--accent1) 30%, var(--border));
      color:var(--text);
    }
    .section{ display:none; }
    .section.active{ display:block; animation: fadeIn .18s ease-out; }
    @keyframes fadeIn{ from{opacity:.35; transform: translateY(2px);} to{opacity:1; transform: translateY(0);} }

    /* Desktop (Mac): show BOTH Today + Stats, hide tabs */
    @media (min-width: 900px){
      .tabs{ display:none; }
      .section{ display:block; }
      .section.active{ display:block; }
      .page{ padding-bottom: 28px; }
    }

    /* Make KPIs less cramped on phones */
    .kpi-grid{ grid-template-columns: 1fr; }
    @media (min-width: 520px){ .kpi-grid{ grid-template-columns: repeat(2, 1fr); } }

    /* Make FAB obvious */
    .fab{
      background: linear-gradient(135deg, #1f3b73, #2b6cb0);
      color:#fff;
      font-weight:900;
    }

    /* Mobile-first layout */
    .page{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 12px 150px; /* bottom space for FAB and bottom bar */
      min-height: calc(100vh - 64px);
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      box-sizing:border-box;
    }

    .card{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      background:var(--panel); border:1px solid var(--border); border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    h1{ margin:0; font-size:15px; }
    h2{ margin: 6px 0 10px 0; font-size:18px; }
    h3{ margin: 0 0 8px 0; font-size: 14px; color:#cfe0f8; }

    /* Checklist */
    .checklist { display:grid; gap:10px; margin-top: 10px; }
    .item{
      display:flex; gap:12px; align-items:center;
      padding:12px;
      border:1px solid var(--border); border-radius:14px; background:var(--panel2);
    }
    .tick{
      width:32px; height:32px; border-radius:12px;
      display:grid; place-items:center;
      border:1px solid color-mix(in srgb, var(--accent1) 30%, var(--border)); user-select:none;
      font-size:16px;
      flex: 0 0 32px;
    }
    .icon{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: color-mix(in srgb, var(--accent1) 16%, var(--panel2));
      border: 1px solid color-mix(in srgb, var(--accent1) 30%, var(--border));
      font-size: 16px;
      flex: 0 0 42px;
    }
    .item.done .tick{ border-color:#3b6a3b; }
    .title{ flex:1; font-weight:900; font-size:16px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .item.done .title{ text-decoration: line-through; opacity:.82; }

    /* Preview */
    .preview{
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      display:grid; gap:8px;
    }
    .kv{ display:flex; justify-content: space-between; gap:10px; }
    .kv span:first-child{ color:#b7c3d6; font-size:12px; }
    .kv span:last-child{ font-size:12px; color:#e8eef6; text-align:right; }

    /* Stats section */
    .stats-card{
      max-width: 720px;
      margin: 14px auto 0;
      background:var(--panel); border:1px solid var(--border); border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:end; justify-content:space-between;
      margin-top: 10px;
    }
    .controls .left, .controls .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }

    .kpi-grid{
      display:grid; gap:10px; margin-top: 12px;
      grid-template-columns: repeat(2, 1fr);
    }
    @media (min-width: 900px){
      .kpi-grid{ grid-template-columns: repeat(4, 1fr); }
    }

    .kpi{
      background:var(--panel2); border:1px solid var(--border); border-radius:14px;
      padding:12px;
    }
    .kpi .num{ font-size: 22px; font-weight: 900; margin-top: 4px; }

    canvas{
      width:100%;
      height: 220px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius: 14px;
      margin-top: 12px;
    }

    /* Desktop table + Mobile cards */
    .table-wrap{ overflow:auto; margin-top: 12px; border:1px solid var(--border); border-radius:14px; }
    table{ width:100%; border-collapse: collapse; background:var(--panel2); }
    th, td{ padding: 10px 10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted2); font-weight:800; position: sticky; top:0; background:var(--panel2); }
    tr:hover td{ background: rgba(255,255,255,0.02); }

    .history-cards{ display:none; margin-top: 12px; }
    .hcard{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:grid;
      gap:8px;
      margin-bottom:10px;
    }
    .hcard .top{ display:flex; justify-content: space-between; align-items:center; gap:10px; }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid color-mix(in srgb, var(--accent1) 30%, var(--border)); background:var(--panel); }

    @media (max-width: 720px){
      .table-wrap{ display:none; }
      .history-cards{ display:block; }
    }

    /* Floating action button for phone */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 86px;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      /* background:#0f1621; */
      border: 1px solid color-mix(in srgb, var(--accent1) 30%, var(--border));
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      display:grid;
      place-items:center;
      font-size: 24px;
      z-index: 20;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index: 50;
      padding: 12px;
    }
    .modal{
      width: min(560px, calc(100vw - 24px));
      background:var(--panel); border:1px solid color-mix(in srgb, var(--border) 75%, var(--accent1)); border-radius:16px;
      padding:14px; box-shadow: 0 18px 70px rgba(0,0,0,.55);
    }
    .modal h3{ margin:0 0 8px 0; }
    .modal .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
    .modal label{ font-size:12px; color:#b7c3d6; display:block; margin-top:10px; }
    .modal input, .modal select{ width: 100%; margin-top:6px; font-size:16px; }

    /* iOS time inputs: make them consistent */
    input[type="time"], input[type="date"]{
      -webkit-appearance: none;
      appearance: none;
    }

    .divider{ height:1px; background:var(--border); margin:12px 0; }

    /* Manage task question rows */
    .qblock{ background:var(--panel2); border:1px solid var(--border); border-radius:14px; padding:12px; }
    body::before{
      content:"";
      position:fixed;
      inset:-200px;
      background:
        radial-gradient(600px 420px at 15% 10%, color-mix(in srgb, var(--accent2) 35%, transparent), transparent 70%),
        radial-gradient(540px 380px at 85% 0%, color-mix(in srgb, var(--accent1) 35%, transparent), transparent 70%),
        radial-gradient(520px 520px at 85% 92%, color-mix(in srgb, var(--accent2) 20%, transparent), transparent 72%);
      pointer-events:none;
      z-index:-1;
      filter: blur(2px);
    }
    .qgrid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 520px){ .qgrid{ grid-template-columns: 1fr; } }

    /* Downloads layout: keep controls full-width and aligned like Timetable */
    .dlGrid{ display:grid; gap:10px; width:100%; }
    .dlGrid .dlRow{ display:grid; grid-template-columns: 1fr; gap:10px; width:100%; }
    @media (min-width: 520px){
      .dlGrid .dlRow{ grid-template-columns: 1fr 1fr auto; align-items:end; }
      .dlGrid .dlRow.two{ grid-template-columns: 1fr auto; }
    }
    .dlGrid label{ width:100%; min-width:0; }
    .dlGrid input, .dlGrid select{ width:100%; }
    .dlGrid button{ width:100%; }
    @media (min-width: 520px){
      .dlGrid button{ width:auto; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap headerBar">
    <div class="headerLeft" aria-hidden="true"></div>

    <div class="brand" aria-label="Daily Pulse">
      <div class="brandText">
        <h1>Daily Pulse</h1>
      </div>
    </div>

    <div class="headerActions">
      <button class="smallbtn iconBtn" id="themeBtn" title="Toggle theme" aria-label="Toggle theme">üåô</button>
    </div>
  </div>
</header>


  <div class="tabs" role="tablist" aria-label="Bottom navigation">
    <button class="tab active" id="tabToday" type="button" aria-label="Checklist"><span class="ico">‚úÖ</span><span class="lbl">Checklist</span></button>
    <button class="tab" id="tabStats" type="button" aria-label="Stats"><span class="ico">üìà</span><span class="lbl">Stats</span></button>
    <button class="tab" id="tabDownloads" type="button" aria-label="Downloads"><span class="ico">‚¨áÔ∏è</span><span class="lbl">Downloads</span></button>
    <button class="tab" id="tabTimetable" type="button" aria-label="Timetable"><span class="ico">üóìÔ∏è</span><span class="lbl">Timetable</span></button>
    <button class="tab" id="tabSettings" type="button" aria-label="Settings"><span class="ico">‚öôÔ∏è</span><span class="lbl">Settings</span></button>
  </div>

<div class="page">

  <section class="section active" id="sectionToday">
    <div class="card">
      <h2>Today</h2>
      <div class="muted">Check a task ‚úÖ to log details. Use the + button to add tasks.</div>
      <div class="checklist" id="checklist"></div>
      <div class="preview" id="preview"></div>
    </div>
  </section>

  <section class="section" id="sectionStats">
    <div class="stats-card">
      <h2 style="margin:0 0 6px 0;">Statistics Report</h2>
      <div class="muted">Choose a task ‚Üí see its related chart + history.</div>

      <div class="controls">
        <div class="left">
          <label class="muted" style="display:flex; flex-direction:column; gap:6px;">
            View
            <select id="statsTaskSelect"></select>
          </label>
          <label class="muted" style="display:flex; flex-direction:column; gap:6px;">
            Range
            <select id="rangeSelect">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="all" selected>All</option>
            </select>
          </label>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="muted">Days logged</div><div class="num" id="kpiDays">0</div></div>
        <div class="kpi"><div class="muted">Days completed</div><div class="num" id="kpiComplete">0</div></div>
        <div class="kpi"><div class="muted">Current streak</div><div class="num" id="kpiStreak">0</div></div>
        <div class="kpi"><div class="muted">Avg completion</div><div class="num" id="kpiAvg">0%</div></div>
      </div>

      <canvas id="chart" width="1100" height="300"></canvas>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Completion</th><th>Task done</th><th id="taskDetailHead">Task details</th>
            </tr>
          </thead>
          <tbody id="statsTbody"></tbody>
        </table>
      </div>

      <div class="history-cards" id="historyCards"></div>
    </div>
  </section>

  <section class="section" id="sectionDownloads">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Downloads</h2>
      <div class="muted">Export your data for the selected date or all history.</div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;">Report</h3>
      <div class="dlGrid">
        <div class="dlRow two">
          <div></div>
          <button class="smallbtn" id="downloadReportBtn">Download HTML report</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">Includes KPIs, charts, and tables for the chosen range.</div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;">CSV</h3>
      <div class="dlGrid">
        <div class="dlRow">
          <label class="muted" style="display:flex; flex-direction:column; gap:6px;">
            CSV type
            <select id="csvModeSelect">
              <option value="day" selected>Day CSV (today)</option>
              <option value="range">Range CSV</option>
            </select>
          </label>

          <div id="rangeInputs" style="display:none; width:100%;">
            <div class="dlRow" style="grid-template-columns: 1fr 1fr; width:100%;">
              <label class="muted" style="display:flex; flex-direction:column; gap:6px; width:100%; min-width:0;">
                From
                <input type="date" id="dlFrom" style="width:100%;" />
              </label>
              <label class="muted" style="display:flex; flex-direction:column; gap:6px; width:100%; min-width:0;">
                To
                <input type="date" id="dlTo" style="width:100%;" />
              </label>
            </div>
          </div>

          <button class="smallbtn" id="downloadCsvBtn">Download CSV</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="muted">If your browser blocks downloads, tap this link:</div>
      <div id="downloadLinkArea" style="margin-top:8px;"></div>
    </div>
  </section>

  <section class="section" id="sectionTimetable">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Timetable</h2>
      <!-- <div class="muted">Plan today‚Äôs schedule. It saves automatically.</div> -->

      <div class="divider"></div>

      <div class="row" style="justify-content: space-between; align-items:end;">
        <label class="muted" style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:200px;">
          Today-week
          <select id="ttViewDaySelect">
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
            <option value="0">Sunday</option>
          </select>
        </label>
        <!-- <div class="pill" id="ttDatePill">Weekly timetable ‚Ä¢ repeats every week</div> -->
      </div>

      <div id="timetableList" class="timetableList"></div>
    </div>
  </section>

  <section class="section" id="sectionSettings">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Settings</h2>
      <div class="muted">Manage tasks and reset options.</div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;">Tasks</h3>
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <button class="smallbtn" id="openTasksBtn">Manage tasks</button>
        <button class="smallbtn danger" id="deleteAllTasksBtn">Delete ALL tasks</button>
      </div>
      <div class="muted" style="margin-top:6px;">Deleting tasks removes them from future days and clears their logs across all days.</div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;">Data</h3>
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <button class="smallbtn" id="goDownloadsBtn">Go to Downloads</button>
        <button class="smallbtn" id="clearTimetableBtn">Clear timetable</button>
        <button class="smallbtn danger" id="wipeBtn2">Clear all data</button>
      </div>
      <div class="muted" style="margin-top:6px;">Wipe deletes tasks + history from this device/browser.</div>
    </div>
  </section>
</div>

<!-- Floating button for phone: add task -->
<button class="fab" id="fabBtn" aria-label="Add task">Ôºã</button>

<!-- Popup Modal: task log/questions -->
<div class="backdrop" id="taskBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content: space-between;">
      <h3 id="taskModalTitle">Log</h3>
      <button class="smallbtn" id="taskCloseBtn">Close</button>
    </div>
    <div class="muted" id="taskModalHint"></div>
    <div class="divider"></div>
    <div id="taskFields"></div>
    <div class="footer">
      <button class="smallbtn danger" id="taskSkipBtn">Skip</button>
      <button id="taskSaveBtn">Save</button>
    </div>
  </div>
</div>

<!-- Manage Modal: add task + questions -->
<div class="backdrop" id="manageBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content: space-between;">
      <h3>Tasks</h3>
      <button class="smallbtn" id="manageCloseBtn">Close</button>
    </div>
    <div class="muted">Add a task and define what questions pop up when it‚Äôs checked.</div>

    <div class="row" style="gap:10px; align-items:end;">
      <label style="flex:1;">Task name
        <input id="newTaskName" placeholder="e.g., Walk" />
      </label>
      <label style="width:120px;">Icon
        <input id="newTaskIcon" placeholder="üôÇ" maxlength="3" />
      </label>
    </div>
    <div class="muted" style="margin-top:6px;">Pick an emoji icon (example: üèãÔ∏è üìö üö∂ üßò ‚òïÔ∏è).</div>

    <div class="divider"></div>

    <div class="row" style="justify-content: space-between;">
      <h3 style="margin:0;">Popup questions</h3>
      <button class="smallbtn" id="addQuestionBtn">+ Add</button>
    </div>
    <div class="muted">Tip: add a <b>number</b> question if you want a chart (e.g., Weight, Steps, Pages).</div>

    <div id="questionsList" style="margin-top:10px; display:grid; gap:10px;"></div>

    <div class="footer">
      <button class="smallbtn danger" id="toggleAdminBtn">Manage existing</button>
      <button id="createTaskBtn">Create</button>
    </div>

    <div id="tasksAdmin" style="display:none; margin-top:12px;">
      <div class="divider"></div>
      <h3 style="margin:0 0 8px 0;">Existing tasks</h3>
      <div class="muted">Delete removes it from future days (history stays).</div>
      <div id="taskListAdmin" style="margin-top:10px; display:grid; gap:10px;"></div>
    </div>
  </div>
</div>

<!-- Timetable Modal -->
<div class="backdrop" id="slotBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content: space-between;">
      <h3 id="slotModalTitle">Add slot</h3>
      <button class="smallbtn" id="slotCloseBtn">Close</button>
    </div>
    <div class="muted">Add one block for today‚Äôs plan.</div>
    <div class="divider"></div>

    <div class="qgrid">
      <div>
        <div style="font-size:12px; color:#b7c3d6; font-weight:800; margin-bottom:8px;">Days</div>

        <label class="allWeekRow">
          <input type="checkbox" id="slotAllWeek" checked />
          <span>All week</span>
        </label>

        <div id="slotDays" class="dayChips" aria-label="Select days">
          <label class="chip" title="Sunday"><input type="checkbox" class="slotDay" value="0" checked /><span>S</span></label>
          <label class="chip" title="Monday"><input type="checkbox" class="slotDay" value="1" checked /><span>M</span></label>
          <label class="chip" title="Tuesday"><input type="checkbox" class="slotDay" value="2" checked /><span>T</span></label>
          <label class="chip" title="Wednesday"><input type="checkbox" class="slotDay" value="3" checked /><span>W</span></label>
          <label class="chip" title="Thursday"><input type="checkbox" class="slotDay" value="4" checked /><span>T</span></label>
          <label class="chip" title="Friday"><input type="checkbox" class="slotDay" value="5" checked /><span>F</span></label>
          <label class="chip" title="Saturday"><input type="checkbox" class="slotDay" value="6" checked /><span>S</span></label>
        </div>

        <div class="muted" style="margin-top:10px;">Tip: turn off ‚ÄúAll week‚Äù to pick one or more days.</div>
      </div>
      <label>Start time
        <input type="time" id="slotStart" />
      </label>
      <label>End time
        <input type="time" id="slotEnd" />
      </label>
    </div>

    <label style="margin-top:10px;">Title
      <input id="slotTitle" placeholder="e.g., Gym" />
    </label>

    <label style="margin-top:10px;">Notes (optional)
      <input id="slotNotes" placeholder="e.g., Chest + cardio" />
    </label>

    <div class="footer">
      <button class="smallbtn danger" id="slotDeleteBtn" style="display:none;">Delete</button>
      <button id="slotSaveBtn">Save</button>
    </div>
  </div>
</div>

<script>
  // ---------------- Storage model (v2) ----------------
  // db = {
  //   tasks: [ { id, name, questions:[{ key, label, type }] } ],
  //   days: { [date]: { done:{[taskId]:true}, answers:{[taskId]:{[key]:value}} } }
  // }
  const KEY = "daily_checklist_phone_v2";

  const ui = {
    checklist: document.getElementById("checklist"),
    preview: document.getElementById("preview"),
    fabBtn: document.getElementById("fabBtn"),

    // tab buttons
    tabToday: document.getElementById("tabToday"),
    tabStats: document.getElementById("tabStats"),
    tabDownloads: document.getElementById("tabDownloads"),
    tabTimetable: document.getElementById("tabTimetable"),
    tabSettings: document.getElementById("tabSettings"),

    // sections
    sectionToday: document.getElementById("sectionToday"),
    sectionStats: document.getElementById("sectionStats"),
    sectionDownloads: document.getElementById("sectionDownloads"),
    sectionSettings: document.getElementById("sectionSettings"),

    // stats
    statsTaskSelect: document.getElementById("statsTaskSelect"),
    rangeSelect: document.getElementById("rangeSelect"),
    chart: document.getElementById("chart"),
    statsTbody: document.getElementById("statsTbody"),
    historyCards: document.getElementById("historyCards"),
    taskDetailHead: document.getElementById("taskDetailHead"),
    kpiDays: document.getElementById("kpiDays"),
    kpiComplete: document.getElementById("kpiComplete"),
    kpiStreak: document.getElementById("kpiStreak"),
    kpiAvg: document.getElementById("kpiAvg"),

    // task modal
    taskBackdrop: document.getElementById("taskBackdrop"),
    taskModalTitle: document.getElementById("taskModalTitle"),
    taskModalHint: document.getElementById("taskModalHint"),
    taskFields: document.getElementById("taskFields"),
    taskCloseBtn: document.getElementById("taskCloseBtn"),
    taskSkipBtn: document.getElementById("taskSkipBtn"),
    taskSaveBtn: document.getElementById("taskSaveBtn"),

    // manage modal
    manageBackdrop: document.getElementById("manageBackdrop"),
    manageCloseBtn: document.getElementById("manageCloseBtn"),
    newTaskName: document.getElementById("newTaskName"),
    newTaskIcon: document.getElementById("newTaskIcon"),
    addQuestionBtn: document.getElementById("addQuestionBtn"),
    questionsList: document.getElementById("questionsList"),
    createTaskBtn: document.getElementById("createTaskBtn"),
    toggleAdminBtn: document.getElementById("toggleAdminBtn"),
    tasksAdmin: document.getElementById("tasksAdmin"),
    taskListAdmin: document.getElementById("taskListAdmin"),
    themeBtn: document.getElementById("themeBtn"),

    // downloads page
    dlFrom: document.getElementById("dlFrom"),
    dlTo: document.getElementById("dlTo"),
    downloadLinkArea: document.getElementById("downloadLinkArea"),
    downloadReportBtn: document.getElementById("downloadReportBtn"),
    csvModeSelect: document.getElementById("csvModeSelect"),
    rangeInputs: document.getElementById("rangeInputs"),
    downloadCsvBtn: document.getElementById("downloadCsvBtn"),

    // settings page
    openTasksBtn: document.getElementById("openTasksBtn"),
    deleteAllTasksBtn: document.getElementById("deleteAllTasksBtn"),
    goDownloadsBtn: document.getElementById("goDownloadsBtn"),
    wipeBtn2: document.getElementById("wipeBtn2"),
    // todayDate: document.getElementById("todayDate"),


    // timetable
    sectionTimetable: document.getElementById("sectionTimetable"),
    // ttDatePill: document.getElementById("ttDatePill"),
    timetableList: document.getElementById("timetableList"),
    ttViewDaySelect: document.getElementById("ttViewDaySelect"),

    // slot modal
    slotBackdrop: document.getElementById("slotBackdrop"),
    slotCloseBtn: document.getElementById("slotCloseBtn"),
    slotModalTitle: document.getElementById("slotModalTitle"),
    slotStart: document.getElementById("slotStart"),
    slotEnd: document.getElementById("slotEnd"),
    slotTitle: document.getElementById("slotTitle"),
    slotNotes: document.getElementById("slotNotes"),
    slotSaveBtn: document.getElementById("slotSaveBtn"),
    slotDeleteBtn: document.getElementById("slotDeleteBtn"),
    slotAllWeek: document.getElementById("slotAllWeek"),
    slotDaysWrap: document.getElementById("slotDays"),
  };

  function todayISO(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function uuid(){
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
  }

  function slugify(s){
    return String(s || "")
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function loadDB(){
    try { return JSON.parse(localStorage.getItem(KEY)) || null; }
    catch { return null; }
  }

  let db = loadDB();
  if (!db){
    // Default tasks
    db = {
      tasks: [
        { id: "gym", name: "Gym", questions: [ { key: "weight_kg", label: "Today‚Äôs weight (kg)", type: "number" } ] },
        { id: "reading", name: "Reading", questions: [ { key: "book_name", label: "Book name", type: "text" }, { key: "pages", label: "Pages read", type: "number" } ] },
      ],
      days: {}
    };
    saveDB();
  }
  // Ensure default icons exist
  db.tasks = (db.tasks || []).map(t => {
    if (t.icon) return t;
    if (t.id === "gym") return { ...t, icon: "üèãÔ∏è" };
    if (t.id === "reading") return { ...t, icon: "üìö" };
    return { ...t, icon: "‚úÖ" };
  });
  saveDB();
  // Timetable (weekly, not calendar)
  // db.schedule = { weekly: { '0':[], '1':[], ... '6':[] } }
  db.schedule = db.schedule || {};
  db.schedule.weekly = db.schedule.weekly || {};
  for (const k of ['0','1','2','3','4','5','6']){
    if (!Array.isArray(db.schedule.weekly[k])) db.schedule.weekly[k] = [];
  }
  saveDB();

  function saveDB(){
    localStorage.setItem(KEY, JSON.stringify(db));
  }
  // Tabs logic (Today / Stats / Downloads / Settings) ‚Äî phone only
  function setTab(which){
    // On desktop, tabs are hidden and all sections are visible
    if (window.matchMedia("(min-width: 900px)").matches) return;

    const map = {
      today: ui.sectionToday,
      stats: ui.sectionStats,
      downloads: ui.sectionDownloads,
      timetable: ui.sectionTimetable,
      settings: ui.sectionSettings,
    };

    Object.entries(map).forEach(([k, el]) => {
      if (!el) return;
      el.classList.toggle("active", k === which);
    });

    // tab button active states
    const tmap = {
      today: ui.tabToday,
      stats: ui.tabStats,
      downloads: ui.tabDownloads,
      timetable: ui.tabTimetable,
      settings: ui.tabSettings,
    };
    Object.entries(tmap).forEach(([k, btn]) => {
      if (!btn) return;
      btn.classList.toggle("active", k === which);
    });

    // Ensure chart redraw when opening Stats
    if (which === "stats") setTimeout(() => { try { renderStats(); } catch(e){} }, 30);
    if (which === "timetable") setTimeout(() => { try { renderTimetable(); } catch(e){} }, 30);

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ---------------- Timetable (weekly, 7 days) ----------------
  const DAY_LABEL = { '0':'Sunday','1':'Monday','2':'Tuesday','3':'Wednesday','4':'Thursday','5':'Friday','6':'Saturday' };

  function dayKeyFromISO(dateISO){
    const d = new Date(dateISO + "T00:00:00");
    return String(d.getDay());
  }

  function getWeeklySlots(dayKey){
    db.schedule = db.schedule || {};
    db.schedule.weekly = db.schedule.weekly || {};
    if (!Array.isArray(db.schedule.weekly[dayKey])) db.schedule.weekly[dayKey] = [];
    return db.schedule.weekly[dayKey];
  }

  function setWeeklySlots(dayKey, slots){
    db.schedule = db.schedule || {};
    db.schedule.weekly = db.schedule.weekly || {};
    db.schedule.weekly[dayKey] = slots;
    saveDB();
  }

  // Selected day to view in timetable page
  let ttViewDayChoice = dayKeyFromISO(todayISO()); // '0'..'6'
  function getViewDayKey(){
    return String(ttViewDayChoice);
  }

  function refreshTimetableDaySelectLabels(){
    if (!ui.ttViewDaySelect) return;
    const todayKey = dayKeyFromISO(todayISO());
    const optMap = {
      '1':'Monday', '2':'Tuesday', '3':'Wednesday', '4':'Thursday',
      '5':'Friday', '6':'Saturday', '0':'Sunday'
    };
    [...ui.ttViewDaySelect.options].forEach(o => {
      const base = optMap[o.value] || o.textContent;
      o.textContent = (o.value === todayKey) ? `${base} ‚Äî Today` : base;
    });
  }

  function to12h(t){
    if (!t) return '‚Äî';
    const parts = String(t).split(':');
    let h = Number(parts[0] || 0);
    const m = parts[1] || '00';
    const ampm = (h >= 12) ? 'PM' : 'AM';
    h = h % 12;
    if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }

  function renderTimetable(){
    const viewKey = getViewDayKey();
    const viewLabel = DAY_LABEL[viewKey] || 'Day';
    refreshTimetableDaySelectLabels();

    const slots = getWeeklySlots(viewKey)
      .slice()
      .sort((a,b) => (a.start || '').localeCompare(b.start || ''));

    if (!ui.timetableList) return;

    if (slots.length === 0){
      ui.timetableList.innerHTML = `
        <div class="ttEmpty">
          <div style="font-weight:950; margin-bottom:6px;">No slots for ${viewLabel}</div>
          <div class="muted">Tap + to add a slot. This schedule repeats every week.</div>
        </div>
      `;
      return;
    }

    ui.timetableList.innerHTML = '';
    slots.forEach(s => {
      const row = document.createElement('div');
      row.className = 'ttRow';

      const time = `${to12h(s.start)} ‚Äì ${to12h(s.end)}`;
      const notes = s.notes ? escapeHTML(s.notes) : '';

      row.innerHTML = `
        <div class="ttTimeCol">${escapeHTML(to12h(s.start))}</div>
        <div class="ttRail"><div class="ttDot"></div></div>
        <div class="ttCard">
          <div class="ttCardTop">
            <div style="min-width:0;">
              <div class="ttTitle">${escapeHTML(s.title || 'Untitled')}</div>
              <div class="ttMeta">${escapeHTML(time)}${notes ? ' ‚Ä¢ ' + notes : ''}</div>
            </div>
            <button class="smallbtn ttEdit" type="button">Edit</button>
          </div>
        </div>
      `;

      row.querySelector('button').addEventListener('click', ()=> openSlotModal(s, viewKey));
      ui.timetableList.appendChild(row);
    });
  }

  let editingSlotId = null;
  let editingDayKey = null;

  function getCheckedSlotDays(){
    if (!ui.slotDaysWrap) return [];
    return [...ui.slotDaysWrap.querySelectorAll('input.slotDay')]
      .filter(cb => cb.checked)
      .map(cb => String(cb.value));
  }

  function setCheckedSlotDays(dayKeys){
    if (!ui.slotDaysWrap) return;
    const set = new Set((dayKeys || []).map(String));
    [...ui.slotDaysWrap.querySelectorAll('input.slotDay')].forEach(cb => {
      cb.checked = set.has(String(cb.value));
    });
  }

  function wireAllWeekToggle() {
    if (!ui.slotAllWeek || !ui.slotDaysWrap) return;

    const allDays = ['0', '1', '2', '3', '4', '5', '6'];

    const setUI = (allWeekOn) => {
      // show chips only when All week is OFF
      ui.slotDaysWrap.style.display = allWeekOn ? 'none' : 'grid';
      // always keep chips enabled when visible
      [...ui.slotDaysWrap.querySelectorAll('input.slotDay')].forEach(cb => cb.disabled = false);
    };

    // initial state
    if (ui.slotAllWeek.checked) {
      setCheckedSlotDays(allDays);     // default all selected
      setUI(true);                    // hide chips
    } else {
      setUI(false);                   // show chips
    }

    ui.slotAllWeek.onchange = () => {
      if (ui.slotAllWeek.checked) {
        setCheckedSlotDays(allDays);
        setUI(true);                  // hide chips
      } else {
        setUI(false);                 // show chips
      }
    };
  }

  function openSlotModal(slot, dayKey){
    editingSlotId = slot?.id || null;
    editingDayKey = dayKey || getViewDayKey();

    const viewLabel = DAY_LABEL[editingDayKey] || 'Day';
    if (ui.slotModalTitle) ui.slotModalTitle.textContent = editingSlotId ? 'Edit slot' : `Add slot (${viewLabel})`;

    // Day selection
    if (ui.slotAllWeek){
      ui.slotAllWeek.checked = !editingSlotId; // new = all week, edit = pick day(s)
    }
    if (!editingSlotId){
      // all week default shows all selected
      setCheckedSlotDays(['0','1','2','3','4','5','6']);
    } else {
      // editing: default to the day being edited
      setCheckedSlotDays([String(editingDayKey)]);
    }
    wireAllWeekToggle();

    if (ui.slotStart) ui.slotStart.value = slot?.start || '';
    if (ui.slotEnd) ui.slotEnd.value = slot?.end || '';
    if (ui.slotTitle) ui.slotTitle.value = slot?.title || '';
    if (ui.slotNotes) ui.slotNotes.value = slot?.notes || '';

    if (ui.slotDeleteBtn) ui.slotDeleteBtn.style.display = editingSlotId ? 'inline-block' : 'none';

    if (ui.slotBackdrop) ui.slotBackdrop.style.display = 'flex';
    setTimeout(()=>{ try{ ui.slotTitle?.focus(); }catch(e){} }, 50);
  }

  function closeSlotModal(){
    editingSlotId = null;
    editingDayKey = null;
    if (ui.slotBackdrop) ui.slotBackdrop.style.display = 'none';
  }
  function getDatesForRange(from, to){
    const all = getAllDatesAsc();
    return all.filter(d => inRange(d, from, to));
  }

  function buildReportHTML(from, to){
    const cs = getComputedStyle(document.documentElement);
    const bg = cs.getPropertyValue('--bg').trim();
    const panel = cs.getPropertyValue('--panel').trim();
    const panel2 = cs.getPropertyValue('--panel2').trim();
    const border = cs.getPropertyValue('--border').trim();
    const text = cs.getPropertyValue('--text').trim();
    const muted = cs.getPropertyValue('--muted').trim();

    const dates = getDatesForRange(from, to);
    const rangeLabel = `${from || '‚Ä¶'} ‚Üí ${to || '‚Ä¶'}`;

    // Snapshot charts as images for: Overall + each task (numeric if present, else done)
    const originalSel = ui.statsTaskSelect.value;
    const originalRange = ui.rangeSelect.value;

    // Force chart to use the same date set
    const chartImages = [];

    // Build list of views
    const views = ['__overall__'].concat((db.tasks || []).map(t => t.id));

    views.forEach(v => {
      ui.statsTaskSelect.value = v;
      drawChart(dates);
      const title = (v === '__overall__') ? 'Overall completion %' : (db.tasks.find(t => t.id === v)?.name || 'Task');
      let img = '';
      try { img = ui.chart.toDataURL('image/png'); } catch(e){ img = ''; }
      chartImages.push({ title, img, id: v });
    });

    // Restore UI state
    ui.statsTaskSelect.value = originalSel;
    ui.rangeSelect.value = originalRange;
    try { renderStats(); } catch(e){}

    // KPIs
    let daysLogged = dates.length;
    let complete = 0;
    let sumPct = 0;
    dates.forEach(d => {
      const day = db.days[d];
      const pct = completionPct(day);
      sumPct += pct;
      if (isDayComplete(day)) complete++;
    });
    const avg = daysLogged ? Math.round(sumPct / daysLogged) : 0;

    // Tables
    function tableForView(viewId){
      const rows = [...dates].reverse().map(d => {
        const day = db.days[d];
        const comp = completionPct(day);
        if (viewId === '__overall__'){
          const doneCount = (db.tasks || []).filter(t => !!day.done?.[t.id]).length;
          return `<tr><td>${d}</td><td>${comp}%</td><td>${doneCount}/${db.tasks.length}</td></tr>`;
        }
        const t = db.tasks.find(x => x.id === viewId);
        if (!t) return '';
        const done = day.done?.[t.id] ? 'Yes' : 'No';
        const det = pickTaskDetailField(t);
        let detail = '';
        if (det){
          const v = day.answers?.[t.id]?.[det.q.key];
          detail = (v !== undefined && v !== '') ? String(v) : '';
        }
        return `<tr><td>${d}</td><td>${comp}%</td><td>${done}</td><td>${escapeHTML(detail)}</td></tr>`;
      }).join('');

      if (viewId === '__overall__'){
        return `
          <table>
            <thead><tr><th>Date</th><th>Completion</th><th>Tasks done</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      const t = db.tasks.find(x => x.id === viewId);
      const det = t ? pickTaskDetailField(t) : null;
      const head = det ? escapeHTML(det.q.label) : 'Details';
      return `
        <table>
          <thead><tr><th>Date</th><th>Completion</th><th>Done</th><th>${head}</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    const chartsHTML = chartImages.map(c => {
      const imgTag = c.img ? `<img src="${c.img}" alt="${escapeHTML(c.title)}" />` : '<div class="muted">Chart not available</div>';
      return `
        <section class="block">
          <h2>${escapeHTML(c.title)}</h2>
          <div class="chart">${imgTag}</div>
          <div class="table">${tableForView(c.id)}</div>
        </section>
      `;
    }).join('');

    return `
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Pulse Report</title>
  <style>
    :root{ --bg:${bg}; --panel:${panel}; --panel2:${panel2}; --border:${border}; --text:${text}; --muted:${muted}; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px 36px; }
    .top{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-end;
      border-bottom:1px solid var(--border); padding-bottom: 12px; margin-bottom: 14px;
    }
    .title{ font-size:26px; font-weight:1000; letter-spacing:.02em; }
    .sub{ color:var(--muted); font-size:12px; }
    .kpis{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin: 14px 0; }
    .kpi{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; }
    .kpi .n{ font-size:22px; font-weight:1000; margin-top:4px; }
    @media (max-width: 820px){ .kpis{ grid-template-columns: repeat(2, 1fr);} }
    .block{ background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:14px; margin-top: 12px; }
    h2{ margin: 0 0 10px 0; font-size: 18px; }
    .chart{ background:var(--panel2); border:1px solid var(--border); border-radius:16px; padding:10px; overflow:hidden; }
    .chart img{ width:100%; height:auto; display:block; }
    .table{ margin-top: 10px; overflow:auto; border:1px solid var(--border); border-radius:16px; }
    table{ width:100%; border-collapse: collapse; background:var(--panel2); }
    th, td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
    th{ position:sticky; top:0; background:var(--panel2); font-size:12px; color:var(--muted); font-weight:900; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Daily Pulse Report</div>
        <div class="sub">Range: ${escapeHTML(rangeLabel)}</div>
      </div>
      <div class="sub">Generated: ${escapeHTML(new Date().toLocaleString())}</div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="sub">Days logged</div><div class="n">${daysLogged}</div></div>
      <div class="kpi"><div class="sub">Days completed</div><div class="n">${complete}</div></div>
      <div class="kpi"><div class="sub">Avg completion</div><div class="n">${avg}%</div></div>
      <div class="kpi"><div class="sub">Tasks</div><div class="n">${(db.tasks||[]).length}</div></div>
    </div>

    ${chartsHTML}
  </div>
</body>
</html>`;
  }

  function downloadHTMLReport(){
    const from = parseISODate(ui.dlFrom?.value);
    const to = parseISODate(ui.dlTo?.value) || todayISO();
    const html = buildReportHTML(from || '', to || '');
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    downloadBlob(`daily-pulse-report-${(from||'start')}-to-${(to||todayISO())}.html`, blob);
  }
  if (ui.slotCloseBtn) ui.slotCloseBtn.addEventListener('click', closeSlotModal);
  if (ui.slotBackdrop) ui.slotBackdrop.addEventListener('click', (e)=>{ if (e.target===ui.slotBackdrop) closeSlotModal(); });

  if (ui.slotSaveBtn) ui.slotSaveBtn.addEventListener('click', ()=>{
    const start = ui.slotStart?.value || '';
    const end = ui.slotEnd?.value || '';
    const title = (ui.slotTitle?.value || '').trim();
    const notes = (ui.slotNotes?.value || '').trim();

    if (!title){ alert('Please enter a title (e.g., Gym).'); return; }

    const allWeek = !!ui.slotAllWeek?.checked;
    const picked = getCheckedSlotDays();
    const targetKeys = allWeek ? ['0','1','2','3','4','5','6'] : picked;

    if (!allWeek && targetKeys.length === 0){
      alert('Select at least one day, or turn on ‚ÄúAll week‚Äù.');
      return;
    }

    targetKeys.forEach(k => {
      const slots = getWeeklySlots(k).slice();
      if (editingSlotId && editingDayKey === k){
        const idx = slots.findIndex(s => s.id === editingSlotId);
        if (idx >= 0) slots[idx] = { ...slots[idx], start, end, title, notes };
      } else if (!editingSlotId){
        slots.push({ id: uuid(), start, end, title, notes });
      }
      setWeeklySlots(k, slots);
    });

    closeSlotModal();
    renderTimetable();
  });

  if (ui.slotDeleteBtn) ui.slotDeleteBtn.addEventListener('click', ()=>{
    if (!editingSlotId) return;
    if (!confirm('Delete this slot?')) return;
    const k = String(editingDayKey || getViewDayKey());
    const slots = getWeeklySlots(k).filter(s => s.id !== editingSlotId);
    setWeeklySlots(k, slots);
    closeSlotModal();
    renderTimetable();
  });



  const THEME_KEY = "daily_pulse_theme";
  function getTheme(){ return localStorage.getItem(THEME_KEY) || "dark"; }
  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    if (ui.themeBtn) ui.themeBtn.textContent = (t === "dark") ? "üåô" : "‚òÄÔ∏è";
  }
  applyTheme(getTheme());
  if (ui.themeBtn){
    ui.themeBtn.addEventListener("click", () => {
      const next = (getTheme() === "dark") ? "light" : "dark";
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
      // re-render chart for best contrast
      try { renderStats(); } catch(e){}
    });
  }

  function getDay(date){
    return db.days[date] || { date, done: {}, answers: {} };
  }

  function setDay(day){
    db.days[day.date] = day;
    saveDB();
  }

  // Remove tasks and also clear their stored logs across all days
  function removeTasksByIds(ids){
    const removeSet = new Set(ids);

    // remove from task list
    db.tasks = (db.tasks || []).filter(t => !removeSet.has(t.id));

    // prune removed task logs from all days
    Object.keys(db.days || {}).forEach(date => {
      const day = db.days[date];
      if (!day) return;
      if (day.done){
        Object.keys(day.done).forEach(tid => { if (removeSet.has(tid)) delete day.done[tid]; });
      }
      if (day.answers){
        Object.keys(day.answers).forEach(tid => { if (removeSet.has(tid)) delete day.answers[tid]; });
      }
    });

    saveDB();
  }

  // ---------------- Checklist (mobile friendly) ----------------
  function renderChecklist(){
    // Since datePicker is removed, always use today
    const date = todayISO();
    const day = getDay(date);

    ui.checklist.innerHTML = "";

    db.tasks.forEach(task => {
      const done = !!day.done?.[task.id];

      const div = document.createElement("div");
      div.className = "item" + (done ? " done" : "");

      const details = task.questions?.length
        ? `${task.questions.length} question${task.questions.length === 1 ? "" : "s"}`
        : "No questions";

      div.innerHTML = `
        <div class="icon">${escapeHTML(task.icon || "‚úÖ")}</div>
        <div class="tick">${done ? "‚úì" : ""}</div>
        <div style="flex:1;">
          <div class="title">${escapeHTML(task.name)}</div>
          <div class="sub">${escapeHTML(details)}</div>
        </div>
        <input type="checkbox" ${done ? "checked" : ""} aria-label="${escapeHTML(task.name)} done" style="width:22px; height:22px;"/>
      `;

      const cb = div.querySelector("input[type=checkbox]");
      const tick = div.querySelector(".tick");
      const title = div.querySelector(".title");
      const iconEl = div.querySelector(".icon");

      function toggle(){
        const next = !day.done?.[task.id];
        day.done = day.done || {};
        day.answers = day.answers || {};
        day.done[task.id] = next;
        setDay(day);
        renderAll();
        if (next) openTaskModal(task, day);
      }

      cb.addEventListener("change", toggle);
      tick.addEventListener("click", () => { cb.checked = !cb.checked; cb.dispatchEvent(new Event("change")); });
      title.addEventListener("click", () => { cb.checked = !cb.checked; cb.dispatchEvent(new Event("change")); });
      iconEl.addEventListener("click", () => { cb.checked = !cb.checked; cb.dispatchEvent(new Event("change")); });

      ui.checklist.appendChild(div);
    });

    renderPreview(day);
  }

  function completionPct(day){
    const total = db.tasks.length;
    if (!total) return 0;
    const doneCount = db.tasks.filter(t => !!day.done?.[t.id]).length;
    return Math.round((doneCount / total) * 100);
  }

  function renderPreview(day){
    ui.preview.innerHTML = "";
    ui.preview.appendChild(kv("Date", day.date));
    ui.preview.appendChild(kv("Completion", `${completionPct(day)}%`));

    // show a few most relevant answers for today (first numeric, first text)
    const todaySummary = summarizeAnswers(day);
    if (todaySummary.length){
      todaySummary.slice(0, 4).forEach(line => ui.preview.appendChild(kv(line.k, line.v)));
    }
  }

  function summarizeAnswers(day){
    const out = [];
    const answers = day.answers || {};
    db.tasks.forEach(t => {
      const a = answers[t.id];
      if (!a) return;
      // Prefer: if task has a number question, show it; else show first text
      const numQ = (t.questions || []).find(q => q.type === "number");
      const textQ = (t.questions || []).find(q => q.type === "text");
      if (numQ && a[numQ.key] !== undefined && a[numQ.key] !== ""){
        out.push({ k: t.name, v: `${numQ.label}: ${a[numQ.key]}` });
        return;
      }
      if (textQ && a[textQ.key] !== undefined && a[textQ.key] !== ""){
        out.push({ k: t.name, v: `${textQ.label}: ${a[textQ.key]}` });
      }
    });
    return out;
  }

  function kv(k,v){
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<span>${escapeHTML(k)}</span><span>${escapeHTML(v)}</span>`;
    return div;
  }

  // ---------------- Task Modal ----------------
  let currentTask = null;

  function openTaskModal(task, day){
    const qs = task.questions || [];
    if (qs.length === 0) return;

    currentTask = task;
    ui.taskModalTitle.textContent = `${task.name} ‚úÖ ‚Äî Quick log`;
    ui.taskModalHint.textContent = "Answer what you want, then Save.";

    ui.taskFields.innerHTML = "";
    const existing = day.answers?.[task.id] || {};

    qs.forEach(q => {
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <label class="muted">${escapeHTML(q.label)}
          <input
            ${q.type === "number" ? 'type="number" step="0.1"' : 'type="text"'}
            data-key="${escapeHTML(q.key)}"
            value="${escapeHTML(existing[q.key] || "") }"
            placeholder="${q.type === "number" ? "Enter a number" : "Type here"}"
          />
        </label>
      `;
      ui.taskFields.appendChild(wrap);
    });

    ui.taskBackdrop.style.display = "flex";
    setTimeout(() => {
      const first = ui.taskFields.querySelector("input");
      if (first) first.focus();
    }, 40);
  }

  function closeTaskModal(){
    ui.taskBackdrop.style.display = "none";
    currentTask = null;
  }

  ui.taskCloseBtn.addEventListener("click", closeTaskModal);
  ui.taskSkipBtn.addEventListener("click", closeTaskModal);
  ui.taskBackdrop.addEventListener("click", (e) => { if (e.target === ui.taskBackdrop) closeTaskModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && ui.taskBackdrop.style.display === "flex") closeTaskModal(); });

  ui.taskSaveBtn.addEventListener("click", () => {
    if (!currentTask) return;
    const date = todayISO();
    const day = getDay(date);

    day.answers = day.answers || {};
    day.answers[currentTask.id] = day.answers[currentTask.id] || {};

    ui.taskFields.querySelectorAll("input[data-key]").forEach(inp => {
      const key = inp.getAttribute("data-key");
      day.answers[currentTask.id][key] = inp.value;
    });

    setDay(day);
    closeTaskModal();
    renderAll();
  });

  // ---------------- Stats (task-based) ----------------
  function getAllDatesAsc(){
    return Object.keys(db.days).sort((a,b) => (a < b ? -1 : 1));
  }

  function filterByRange(datesAsc){
    const r = ui.rangeSelect.value;
    if (r === "all") return datesAsc;
    const n = Number(r);
    return datesAsc.slice(Math.max(0, datesAsc.length - n));
  }

  function isDayComplete(day){
    return db.tasks.length > 0 && db.tasks.every(t => !!day.done?.[t.id]);
  }

  function calcStreak(datesAsc){
    if (datesAsc.length === 0) return 0;
    const latest = datesAsc[datesAsc.length - 1];
    let streak = 0;
    let cur = new Date(latest + "T00:00:00");
    while (true){
      const iso = cur.toISOString().slice(0,10);
      const day = db.days[iso];
      if (!day) break;
      if (!isDayComplete(day)) break;
      streak++;
      cur.setDate(cur.getDate() - 1);
    }
    return streak;
  }

  function renderStatsSelectors(){
    // Populate: Overall + each task
    const current = ui.statsTaskSelect.value;
    ui.statsTaskSelect.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "__overall__";
    optAll.textContent = "Overall completion";
    ui.statsTaskSelect.appendChild(optAll);

    db.tasks.forEach(t => {
      const o = document.createElement("option");
      o.value = t.id;
      o.textContent = `${t.icon ? t.icon + " " : ""}${t.name}`;
      ui.statsTaskSelect.appendChild(o);
    });

    if (current && [...ui.statsTaskSelect.options].some(o => o.value === current)){
      ui.statsTaskSelect.value = current;
      return;
    }

    // Default to first numeric task (line chart), else overall
    const firstNumeric = (db.tasks || []).find(t => {
      const det = pickTaskDetailField(t);
      return det && det.kind === "number";
    });
    ui.statsTaskSelect.value = firstNumeric ? firstNumeric.id : "__overall__";
  }

  function renderKPIs(datesAsc){
    const daysLogged = datesAsc.length;
    let complete = 0;
    let sumPct = 0;

    datesAsc.forEach(d => {
      const day = db.days[d];
      const pct = completionPct(day);
      sumPct += pct;
      if (isDayComplete(day)) complete++;
    });

    ui.kpiDays.textContent = String(daysLogged);
    ui.kpiComplete.textContent = String(complete);
    ui.kpiStreak.textContent = String(calcStreak(datesAsc));
    ui.kpiAvg.textContent = daysLogged ? (Math.round(sumPct / daysLogged) + "%") : "0%";
  }

  function pickTaskDetailField(task){
    // Prefer first number question (for chart), else first text
    const qs = task.questions || [];
    const numQ = qs.find(q => q.type === "number");
    if (numQ) return { kind: "number", q: numQ };
    const textQ = qs.find(q => q.type === "text");
    if (textQ) return { kind: "text", q: textQ };
    return null;
  }

  function buildSeries(datesAsc, selected){
    // returns [{date,value,label?}]
    if (selected === "__overall__"){
      return datesAsc.map(d => ({ date: d, value: completionPct(db.days[d]) }));
    }

    const task = db.tasks.find(t => t.id === selected);
    if (!task){
      return datesAsc.map(d => ({ date:d, value:null }));
    }

    // Use numeric field if exists; otherwise done(0/1)
    const det = pickTaskDetailField(task);

    if (det && det.kind === "number"){
      return datesAsc.map(d => {
        const day = db.days[d];
        const vRaw = day.answers?.[task.id]?.[det.q.key];
        const v = (vRaw === undefined || vRaw === "") ? null : Number(vRaw);
        return { date: d, value: Number.isNaN(v) ? null : v };
      });
    }

    // no numeric: show done as 1/0
    return datesAsc.map(d => {
      const day = db.days[d];
      return { date: d, value: day.done?.[task.id] ? 1 : 0 };
    });
  }

  function drawChart(datesAsc){
    const selected = ui.statsTaskSelect.value || "__overall__";
    const ctx = ui.chart.getContext("2d");
    const w = ui.chart.width, h = ui.chart.height;
    ctx.clearRect(0,0,w,h);

    // Get computed theme colors
    const cs = getComputedStyle(document.documentElement);
    const muted = cs.getPropertyValue('--muted').trim() || "#9fb0c9";
    const border = cs.getPropertyValue('--border').trim() || "#1f2a37";
    const text = cs.getPropertyValue('--text').trim() || "#e8eef6";

    // Frame
    const x0 = 52, x1 = w - 14, y0 = 16, y1 = h - 34;
    ctx.strokeStyle = border;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x0, y1);
    ctx.lineTo(x1, y1);
    ctx.stroke();

    if (datesAsc.length === 0){
      ctx.fillStyle = muted;
      ctx.font = "12px system-ui";
      ctx.fillText("No data yet", x0 + 10, Math.floor(h/2));
      return;
    }

    const series = buildSeries(datesAsc, selected);
    const vals = series.map(p => p.value).filter(v => v !== null);

    if (vals.length === 0){
      ctx.fillStyle = muted;
      ctx.font = "12px system-ui";
      ctx.fillText("No values yet for this view", x0 + 10, Math.floor(h/2));
      return;
    }

    const min = Math.min(...vals);
    const max = Math.max(...vals);
    const span = (max - min) || 1;
    const pad = span * 0.15;
    const yMin = min - pad;
    const yMax = max + pad;

    // Title
    ctx.fillStyle = muted;
    ctx.font = "12px system-ui";

    const title = (selected === "__overall__")
      ? "Overall completion %"
      : (() => {
          const t = db.tasks.find(x => x.id === selected);
          const det = t ? pickTaskDetailField(t) : null;
          if (!t) return "Task";
          if (det && det.kind === "number") return `${t.name} ‚Äî ${det.q.label}`;
          return `${t.name} ‚Äî done`;
        })();

    ctx.fillText(title, x0, 14);

    // Axis labels
    ctx.fillText(datesAsc[0], x0, h - 10);
    const last = datesAsc[datesAsc.length - 1];
    const tw = ctx.measureText(last).width;
    ctx.fillText(last, Math.max(x0, x1 - tw), h - 10);

    // Helper to map series point to canvas coords
    const xAt = (i) => x0 + (i / Math.max(1, series.length - 1)) * (x1 - x0);
    const yAt = (val) => y1 - ((val - yMin) / (yMax - yMin)) * (y1 - y0);

    // Light horizontal gridlines + Y labels (min/mid/max)
    const gridYs = [yMin, (yMin + yMax) / 2, yMax];
    ctx.strokeStyle = "rgba(159,176,201,0.12)";
    ctx.lineWidth = 1;
    gridYs.forEach((gv, idx) => {
      const gy = yAt(gv);
      ctx.beginPath();
      ctx.moveTo(x0, gy);
      ctx.lineTo(x1, gy);
      ctx.stroke();

      // Label
      ctx.fillStyle = muted;
      ctx.font = "11px system-ui";
      const label = (selected === "__overall__") ? `${Math.round(gv)}%` : `${Math.round(gv * 10) / 10}`;
      ctx.fillText(label, 6, Math.max(12, Math.min(h - 10, gy + 4)));
    });

    // Always draw a line chart (no bars)
    ctx.strokeStyle = text;
    ctx.lineWidth = 2;

    // Draw line segments; break on missing values so it never fakes a trend
    let prev = null;
    series.forEach((p, i) => {
      if (p.value === null) { prev = null; return; }
      const x = xAt(i);
      const y = yAt(p.value);
      if (prev === null){
        prev = { x, y };
      } else {
        ctx.beginPath();
        ctx.moveTo(prev.x, prev.y);
        ctx.lineTo(x, y);
        ctx.stroke();
        prev = { x, y };
      }
    });

    // Points + small value labels for clarity
    series.forEach((p, i) => {
      if (p.value === null) return;
      const x = xAt(i);
      const y = yAt(p.value);

      ctx.beginPath();
      ctx.arc(x, y, 3.25, 0, Math.PI * 2);
      ctx.fillStyle = text;
      ctx.fill();

      // value label (avoid overcrowding)
      if (series.length <= 14 || i % 2 === 0){
        ctx.fillStyle = muted;
        ctx.font = "10px system-ui";
        const txt = `${Math.round(p.value * 10) / 10}`;
        ctx.fillText(txt, x + 6, y - 6);
      }
    });
  }

  function renderTable(datesAsc){
    const selected = ui.statsTaskSelect.value || "__overall__";

    ui.statsTbody.innerHTML = "";
    ui.historyCards.innerHTML = "";

    // dynamic header for details
    let head = "Task details";
    if (selected === "__overall__"){
      head = "All tasks";
    } else {
      const t = db.tasks.find(x => x.id === selected);
      const det = t ? pickTaskDetailField(t) : null;
      if (t && det && det.kind === "number") head = `${t.name}: ${det.q.label}`;
      else if (t && det && det.kind === "text") head = `${t.name}: ${det.q.label}`;
      else if (t) head = `${t.name}: done`;
    }
    ui.taskDetailHead.textContent = head;

    if (datesAsc.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="4">No history yet. Start checking tasks daily.</td>`;
      ui.statsTbody.appendChild(tr);
      const hc = document.createElement("div");
      hc.className = "hcard";
      hc.innerHTML = `<div class="muted">No history yet. Start checking tasks daily.</div>`;
      ui.historyCards.appendChild(hc);
      return;
    }

    // newest first
    [...datesAsc].reverse().forEach(d => {
      const day = db.days[d];
      const comp = completionPct(day);

      let taskDone = "‚Äî";
      let detail = "‚Äî";

      if (selected === "__overall__"){
        taskDone = `${comp === 100 ? "‚úÖ" : "‚Äî"}`;
        const doneCount = db.tasks.filter(t => !!day.done?.[t.id]).length;
        detail = `${doneCount}/${db.tasks.length} tasks done`;
      } else {
        const t = db.tasks.find(x => x.id === selected);
        if (t){
          taskDone = day.done?.[t.id] ? "‚úÖ" : "‚Äî";
          const det = pickTaskDetailField(t);
          if (det){
            const v = day.answers?.[t.id]?.[det.q.key];
            detail = (v !== undefined && v !== "") ? String(v) : "‚Äî";
          } else {
            detail = day.done?.[t.id] ? "Done" : "Not done";
          }
        }
      }

      // Desktop table row
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(d)}</td>
        <td>${comp}%</td>
        <td>${taskDone}</td>
        <td>${escapeHTML(detail)}</td>
      `;
      ui.statsTbody.appendChild(tr);

      // Mobile card
      const hc = document.createElement("div");
      hc.className = "hcard";
      hc.innerHTML = `
        <div class="top">
          <div style="font-weight:800;">${escapeHTML(d)}</div>
          <span class="badge">${comp}%</span>
        </div>
        <div class="row" style="justify-content: space-between;">
          <div class="muted">Task</div>
          <div>${selected === "__overall__" ? "Overall" : escapeHTML((db.tasks.find(x => x.id === selected)?.name || "Task"))}</div>
        </div>
        <div class="row" style="justify-content: space-between;">
          <div class="muted">Done</div>
          <div>${taskDone}</div>
        </div>
        <div class="row" style="justify-content: space-between;">
          <div class="muted">Details</div>
          <div style="text-align:right;">${escapeHTML(detail)}</div>
        </div>
      `;
      ui.historyCards.appendChild(hc);
    });
  }

  function renderStats(){
    renderStatsSelectors();
    const all = getAllDatesAsc();
    const dates = filterByRange(all);

    renderKPIs(dates);
    drawChart(dates);
    renderTable(dates);
  }

  // Direct download helper (no Share sheet). Also renders a visible download link fallback.
  function downloadBlob(filename, blob){
    // Create object URL
    let url = "";
    try {
      url = URL.createObjectURL(blob);
    } catch (e){
      alert("Could not create download.");
      return;
    }

    // Always show a visible link fallback
    if (ui.downloadLinkArea){
      ui.downloadLinkArea.innerHTML = `
        <a href="${url}" download="${filename}" style="display:inline-block; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--panel2); text-decoration:none; color:var(--text); font-weight:800;">
          Tap to download ${filename}
        </a>
      `;
    }

    // Try programmatic download
    try {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch (e){
      // ignore; user can tap the visible link
    }

    // Revoke later (give user time to tap)
    setTimeout(() => {
      try { URL.revokeObjectURL(url); } catch(e){}
    }, 5 * 60 * 1000);
  }
  function parseISODate(s){
    return String(s || "").slice(0,10);
  }

  function inRange(d, from, to){
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  }

  function exportCSVRange(from, to){
    const datesAsc = getAllDatesAsc().filter(d => inRange(d, from, to));
    if (datesAsc.length === 0){
      alert("No data in that date range.");
      return;
    }

    // Build dynamic columns: each task -> done + first numeric/text field
    const taskCols = [];
    db.tasks.forEach(t => {
      taskCols.push({ col: `${t.id}_done`, label: `${t.name} done`, kind: "done", taskId: t.id });
      const det = pickTaskDetailField(t);
      if (det){
        taskCols.push({ col: `${t.id}_${det.q.key}`, label: `${t.name}: ${det.q.label}`, kind: "ans", taskId: t.id, key: det.q.key });
      }
    });

    const header = ["date","completionPct"].concat(taskCols.map(c => c.col));
    const lines = [header.join(",")];

    datesAsc.forEach(d => {
      const day = db.days[d];
      const row = [d, String(completionPct(day))];

      taskCols.forEach(c => {
        if (c.kind === "done"){
          row.push(String(!!day.done?.[c.taskId]));
        } else {
          const v = day.answers?.[c.taskId]?.[c.key];
          row.push(csvCell(v ?? ""));
        }
      });

      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const label = (from || "") + "_to_" + (to || "");
    downloadBlob(`daily-pulse-range-${label || todayISO()}.csv`, blob);
  }

  function csvCell(v){
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  function exportCSV(){
    const datesAsc = getAllDatesAsc();

    // Build dynamic columns: each task -> done + first numeric/text field
    const taskCols = [];
    db.tasks.forEach(t => {
      taskCols.push({ col: `${t.id}_done`, label: `${t.name} done`, kind: "done", taskId: t.id });
      const det = pickTaskDetailField(t);
      if (det){
        taskCols.push({ col: `${t.id}_${det.q.key}`, label: `${t.name}: ${det.q.label}`, kind: "ans", taskId: t.id, key: det.q.key });
      }
    });

    const header = ["date","completionPct"].concat(taskCols.map(c => c.col));
    const lines = [header.join(",")];

    datesAsc.forEach(d => {
      const day = db.days[d];
      const row = [d, String(completionPct(day))];

      taskCols.forEach(c => {
        if (c.kind === "done"){
          row.push(String(!!day.done?.[c.taskId]));
        } else {
          const v = day.answers?.[c.taskId]?.[c.key];
          row.push(csvCell(v ?? ""));
        }
      });

      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    downloadBlob(`daily-pulse-all-${todayISO()}.csv`, blob);
  }

  // Export selected day as CSV
  function exportDayCSV(d){
    const day = db.days[d];
    if (!day){
      alert("No data for selected day.");
      return;
    }
    const header = ["date","completionPct"];
    const row = [d, String(completionPct(day))];
    db.tasks.forEach(t => {
      header.push(`${t.name} done`);
      row.push(String(!!day.done?.[t.id]));
      const det = pickTaskDetailField(t);
      if (det){
        header.push(`${t.name}: ${det.q.label}`);
        row.push(csvCell(day.answers?.[t.id]?.[det.q.key] ?? ""));
      }
    });
    const csv = header.join(",") + "\n" + row.join(",");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    downloadBlob(`daily-pulse-${d}.csv`, blob);
  }


  // ---------------- Manage tasks modal ----------------
  let questionDrafts = [];

  function openManage(){
    ui.newTaskName.value = "";
    if (ui.newTaskIcon) ui.newTaskIcon.value = "";
    questionDrafts = [];
    renderQuestionDrafts();
    ui.tasksAdmin.style.display = "none";
    ui.manageBackdrop.style.display = "flex";
  }

  function closeManage(){
    ui.manageBackdrop.style.display = "none";
  }

  // ui.fabBtn.addEventListener("click", openManage);
  ui.manageCloseBtn.addEventListener("click", closeManage);
  ui.manageBackdrop.addEventListener("click", (e) => { if (e.target === ui.manageBackdrop) closeManage(); });

  ui.addQuestionBtn.addEventListener("click", () => {
    questionDrafts.push({ label: "", type: "text" });
    renderQuestionDrafts();
  });

  function renderQuestionDrafts(){
    ui.questionsList.innerHTML = "";
    if (questionDrafts.length === 0){
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "No questions yet. Add one if you want a popup when the task is checked.";
      ui.questionsList.appendChild(d);
      return;
    }

    questionDrafts.forEach((q, idx) => {
      const block = document.createElement("div");
      block.className = "qblock";
      block.innerHTML = `
        <div class="qgrid">
          <label>Question label
            <input data-idx="${idx}" data-field="label" placeholder="e.g., Steps today" value="${escapeHTML(q.label)}" />
          </label>
          <label>Type
            <select data-idx="${idx}" data-field="type">
              <option value="text" ${q.type === "text" ? "selected" : ""}>Text</option>
              <option value="number" ${q.type === "number" ? "selected" : ""}>Number</option>
            </select>
          </label>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:10px;">
          <button class="smallbtn danger" data-del="${idx}">Remove</button>
        </div>
      `;

      block.querySelectorAll("input[data-field], select[data-field]").forEach(el => {
        const update = () => {
          const i = Number(el.getAttribute("data-idx"));
          const f = el.getAttribute("data-field");
          questionDrafts[i][f] = el.value;
        };
        el.addEventListener("input", update);
        el.addEventListener("change", update);
      });

      block.querySelector("[data-del]").addEventListener("click", () => {
        questionDrafts.splice(idx, 1);
        renderQuestionDrafts();
      });

      ui.questionsList.appendChild(block);
    });
  }

  ui.createTaskBtn.addEventListener("click", () => {
    const name = ui.newTaskName.value.trim();
    const icon = (ui.newTaskIcon?.value || "").trim();
    if (!name){
      alert("Please enter a task name.");
      return;
    }

    const id = slugify(name) || uuid();
    if (db.tasks.some(t => t.id === id)){
      alert("Task already exists. Choose a different name.");
      return;
    }

    const questions = questionDrafts
      .map(q => ({ label: (q.label||"").trim(), type: q.type }))
      .filter(q => q.label.length > 0)
      .map(q => ({ key: slugify(q.label) || uuid(), label: q.label, type: q.type }));

    db.tasks.push({ id, name, icon: icon || "‚úÖ", questions });
    saveDB();

    closeManage();
    renderAll();
  });

  ui.toggleAdminBtn.addEventListener("click", () => {
    ui.tasksAdmin.style.display = (ui.tasksAdmin.style.display === "none") ? "block" : "none";
    renderTasksAdmin();
  });

  function renderTasksAdmin(){
    ui.taskListAdmin.innerHTML = "";
    db.tasks.forEach(t => {
      const row = document.createElement("div");
      row.className = "qblock";
      row.innerHTML = `
        <div class="row" style="justify-content: space-between; align-items:center;">
          <div>
            <div style="font-weight:800;">${escapeHTML(t.name)}</div>
            <div class="muted">${(t.questions?.length || 0)} question(s)</div>
          </div>
          <button class="smallbtn danger">Delete</button>
        </div>
      `;

      row.querySelector("button").addEventListener("click", () => {
        if (!confirm(`Delete task "${t.name}"?`)) return;
        removeTasksByIds([t.id]);
        renderTasksAdmin();
        renderAll();
      });

      ui.taskListAdmin.appendChild(row);
    });
  }

  // ---------------- Wire up ----------------
  // No datePicker anymore; always today
  if (ui.dlFrom) ui.dlFrom.value = "";
  if (ui.dlTo) ui.dlTo.value = todayISO();

  ui.statsTaskSelect.addEventListener("change", () => renderStats());
  ui.rangeSelect.addEventListener("change", () => renderStats());

  function clearAllData() {
    if (!confirm("Clear ALL entered logs/history on this device? (Tasks and timetable will stay)")) return;
    db.days = {};           // only logs
    saveDB();
    if (ui.downloadLinkArea) ui.downloadLinkArea.innerHTML = "";
    renderAll();
    alert("Logs cleared. Your tasks and timetable are kept.");
  }

  // Downloads page actions
  function syncCsvUI(){
    const mode = ui.csvModeSelect?.value || 'day';
    if (ui.rangeInputs) ui.rangeInputs.style.display = (mode === 'range') ? 'block' : 'none';
    if (ui.dlTo) ui.dlTo.value = ui.dlTo.value || todayISO();
  }

  if (ui.csvModeSelect) ui.csvModeSelect.addEventListener('change', syncCsvUI);
  syncCsvUI();

  if (ui.downloadCsvBtn) ui.downloadCsvBtn.addEventListener('click', () => {
    const mode = ui.csvModeSelect?.value || 'day';
    if (mode === 'range'){
      const from = parseISODate(ui.dlFrom?.value);
      const to = parseISODate(ui.dlTo?.value) || todayISO();
      exportCSVRange(from || '', to || '');
      return;
    }
    exportDayCSV(todayISO());
  });
  if (ui.downloadReportBtn) ui.downloadReportBtn && ui.downloadReportBtn.addEventListener('click', downloadHTMLReport);

  // Settings page actions
  if (ui.openTasksBtn) ui.openTasksBtn.addEventListener("click", () => openManage());
  if (ui.deleteAllTasksBtn) ui.deleteAllTasksBtn.addEventListener("click", () => {
    if (!confirm("Delete ALL tasks? This will clear task logs for those tasks across all days.")) return;
    const ids = (db.tasks || []).map(t => t.id);
    removeTasksByIds(ids);
    renderAll();
    alert("All tasks deleted.");
  });
  if (ui.goDownloadsBtn) ui.goDownloadsBtn.addEventListener("click", () => setTab("downloads"));
  if (ui.wipeBtn2) ui.wipeBtn2.addEventListener("click", clearAllData);

  // Timetable day selector (7 days)
  if (ui.ttViewDaySelect){
    refreshTimetableDaySelectLabels();
    ui.ttViewDaySelect.value = dayKeyFromISO(todayISO());
    ttViewDayChoice = ui.ttViewDaySelect.value;

    ui.ttViewDaySelect.addEventListener('change', () => {
      ttViewDayChoice = ui.ttViewDaySelect.value;
      renderTimetable();
    });
  }

  // FAB behavior: checklist opens task manager, timetable opens add slot for TODAY
  if (ui.fabBtn){
    ui.fabBtn.onclick = () => {
      const ttActive = ui.sectionTimetable?.classList.contains('active');
      if (ttActive){
        openSlotModal(null, dayKeyFromISO(todayISO()));
      } else {
        openManage();
      }
    };
  }

  // Patch setTab to show FAB only on today and timetable
  const origSetTab = setTab;
  setTab = function(which){
    // On desktop, tabs are hidden and all sections are visible
    if (window.matchMedia("(min-width: 900px)").matches) return;

    const map = {
      today: ui.sectionToday,
      stats: ui.sectionStats,
      downloads: ui.sectionDownloads,
      timetable: ui.sectionTimetable,
      settings: ui.sectionSettings,
    };

    Object.entries(map).forEach(([k, el]) => {
      if (!el) return;
      el.classList.toggle("active", k === which);
    });

    // tab button active states
    const tmap = {
      today: ui.tabToday,
      stats: ui.tabStats,
      downloads: ui.tabDownloads,
      timetable: ui.tabTimetable,
      settings: ui.tabSettings,
    };
    Object.entries(tmap).forEach(([k, btn]) => {
      if (!btn) return;
      btn.classList.toggle("active", k === which);
    });

    // Ensure chart redraw when opening Stats
    if (which === "stats") setTimeout(() => { try { renderStats(); } catch(e){} }, 30);
    if (which === "timetable") setTimeout(() => { try { renderTimetable(); } catch(e){} }, 30);

    window.scrollTo({ top: 0, behavior: "smooth" });

    if (ui.fabBtn){
      const show = (which === 'today' || which === 'timetable');
      ui.fabBtn.style.display = show ? 'grid' : 'none';
      ui.fabBtn.setAttribute('aria-label', which === 'timetable' ? 'Add slot' : 'Add task');
    }
  };

  // Bottom tab navigation
  if (ui.tabToday) ui.tabToday.addEventListener("click", () => setTab("today"));
  if (ui.tabStats) ui.tabStats.addEventListener("click", () => setTab("stats"));
  if (ui.tabDownloads) ui.tabDownloads.addEventListener("click", () => setTab("downloads"));
  if (ui.tabTimetable) ui.tabTimetable.addEventListener("click", () => setTab("timetable"));
  if (ui.tabSettings) ui.tabSettings.addEventListener("click", () => setTab("settings"));

  function renderAll(){
    renderChecklist();
    renderStats();
    renderTimetable();
  }

  renderAll();
  try { refreshTimetableDaySelectLabels(); } catch(e){}

  // Default to Today tab on phones
  if (!window.matchMedia("(min-width: 900px)").matches){
    setTab("today");
  }
// --- Remove unused openSettings/closeSettings ---
</script>
</body>
</html>
